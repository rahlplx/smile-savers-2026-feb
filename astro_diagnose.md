{
  "code": 200,
  "data": {
    "description": "",
    "html": "<html><head><meta name=\"color-scheme\" content=\"light dark\"></head><body><pre style=\"word-wrap: break-word; white-space: pre-wrap;\"># Diagnose\n\nFind the root cause of a reproduced bug in the Astro source code.\n\n**CRITICAL: You MUST always read `report.md` and append to `report.md` before finishing, regardless of outcome. Even if you cannot identify the root cause, hit errors, or the investigation is inconclusive — always update `report.md` with your findings. The orchestrator and downstream skills depend on this file to determine what happened.**\n\n## Prerequisites\n\nThese variables are referenced throughout this skill. They may be passed as args by an orchestrator, or inferred from the conversation when run standalone.\n\n- **`triageDir`** — Directory containing the reproduction project (e.g. `triage/issue-123`). If not passed as an arg, infer from previous conversation.\n- **`issueDetails`** - The GitHub API issue details payload. This must be provided explicitly by the user or available from prior conversation context / tool calls. If this data isn't available, you may run `gh issue view ${issue_number}` to load the missing issue details directly from GitHub.\n- **`report.md`** — File in `triageDir` that MAY exist. Contains the full context from all previous skills.\n- **Astro Compiler source** — The `withastro/compiler` repo MAY be cloned at `.compiler/` (inside the repo root, gitignored). If it exists, treat it as in-scope for diagnosis. Some bugs originate in the compiler rather than in `packages/` — if stack traces or investigation point to compiler behavior (e.g. HTML parsing, `.astro` file transformation), check `.compiler/` for relevant source code.\n\n## Overview\n\n1. Review the reproduction and error details from `report.md`\n2. Locate the relevant source files in `packages/`\n3. Add instrumentation to understand the code path\n4. Identify the root cause\n5. Append diagnosis findings to `report.md`\n\n## Step 1: Review the Reproduction\n\nStart by reading `report.md` from the `triageDir` directory.\n\n**Skip if not reproduced:** If `report.md` shows the bug was NOT reproduced or was skipped (look for \"could not reproduce\", \"SKIP REASON\", \"skipped: true\"), append \"DIAGNOSIS SKIPPED: No reproduction\" to `report.md` and return `confidence: null`.\n\nRe-run the reproduction if needed to see the error firsthand:\n\n```bash\npnpm -C <triageDir> run build  # or dev/preview\n```\n\n## Step 2: Locate Relevant Source Files\n\nUsing the error messages, stack traces, and any other reproduction details from Step 1, identify the source files in `packages/` that are likely involved.\n\n## Step 3: Investigate with Instrumentation\n\nAdd `console.log` statements to understand the code path:\n\n```typescript\n// In packages/astro/src/core/build/index.ts\nconsole.log('[DEBUG] Building page:', pagePath);\nconsole.log('[DEBUG] Props:', JSON.stringify(props, null, 2));\n```\n\nAfter adding logs:\n\n1. Rebuild the package (Example: `pnpm -C packages/astro build`)\n2. Re-run the reproduction (Example: `pnpm -C <triageDir> build|dev|preview`)\n3. Observe the debug output.\n\nIterate until you understand:\n\n- What code path is executing\n- What data is being passed\n- Where the logic diverges from expected behavior\n\n## Step 4: Identify Root Cause\n\nOnce you understand the issue, document:\n\n1. **Which file(s)** contain the bug\n2. **What the code does wrong** — the specific logic error\n3. **Why this causes the observed behavior** — how the error manifests\n4. **What the fix should be** — high-level approach\n\nConsider:\n\n- Is this a regression from a recent change?\n- Does this affect other similar use cases?\n- Are there edge cases to consider?\n\n## Step 5: Write Output\n\nAppend your diagnosis findings to the existing `report.md` (written by the reproduce skill).\n\nInclude a new section with everything you learned: the root cause, affected files with line numbers, detailed explanation of the code path, instrumentation results, and your suggested fix approach. This helps the fix skill work faster.\n\nThe report must include all information needed for a final GitHub comment to be generated later by the comment skill. Make sure to include:\n\n- Root cause explanation (which files, what logic is wrong, why)\n- Affected file paths with line numbers\n- Suggested fix approach\n- Confidence level (`high`, `medium`, or `low`) and any caveats\n</pre></body></html>",
    "title": "",
    "url": "https://raw.githubusercontent.com/withastro/astro/main/.agents/skills/triage/diagnose.md",
    "usage": {
      "tokens": 1002
    }
  },
  "meta": {
    "usage": {
      "tokens": 1002
    }
  },
  "status": 20000
}